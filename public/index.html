<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Museos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">Sistema de Museos</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('museos')">Museos</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('empleados')">Empleados</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('obras')">Obras</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('lugares')">Lugares</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('estructura')">Estructura Organizacional</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Sección Lugares -->
        <div id="lugares" class="form-section">
            <h2 class="section-header">Gestión de Lugares</h2>
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Nuevo Lugar</h5>
                            <form id="lugarForm">
                                <div class="mb-3">
                                    <label class="form-label">Nombre del Lugar</label>
                                    <input type="text" class="form-control" name="nombreLugar" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Tipo</label>
                                    <select class="form-control" name="tipo" id="tipoLugar" onchange="handleTipoLugarChange()" required>
                                        <option value="pais">País</option>
                                        <option value="ciudad">Ciudad</option>
                                    </select>
                                </div>
                                <div class="mb-3" id="paisSelectContainer" style="display: none;">
                                    <label class="form-label">País</label>
                                    <select class="form-control" name="idJerarquia" id="paisSelect">
                                        <!-- Los países se cargarán aquí -->
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary">Guardar</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Lista de Lugares</h5>
                            <div id="lugaresLista" class="list-group">
                                <!-- Los lugares se cargarán aquí dinámicamente -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sección Museos -->
        <div id="museos" class="form-section active">
            <h2 class="section-header">Gestión de Museos</h2>
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Nuevo Museo</h5>
                            <form id="museoForm">
                                <div class="mb-3">
                                    <label class="form-label">Nombre</label>
                                    <input type="text" class="form-control" name="nombre" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Misión</label>
                                    <textarea class="form-control" name="mision" rows="3"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Fecha de Fundación</label>
                                    <input type="date" class="form-control" name="fechaFundacion" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">País</label>
                                    <select class="form-control" name="pais" id="paisMuseo" onchange="cargarCiudades()" required>
                                        <option value="">Seleccione un país</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Ciudad</label>
                                    <select class="form-control" name="idLugar" id="ciudadMuseo" required>
                                        <option value="">Seleccione primero un país</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary">Guardar</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Lista de Museos</h5>
                            <div id="museosLista" class="list-group">
                                <!-- Los museos se cargarán aquí dinámicamente -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sección Empleados -->
        <div id="empleados" class="form-section">
            <h2 class="section-header">Expediente de Empleado</h2>
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Datos Personales</h5>
                            <form id="empleadoForm">
                                <!-- Datos Personales -->
                                <div class="mb-3">
                                    <label class="form-label">Primer Nombre *</label>
                                    <input type="text" class="form-control" name="primerNombre" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Segundo Nombre</label>
                                    <input type="text" class="form-control" name="segundoNombre">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Primer Apellido *</label>
                                    <input type="text" class="form-control" name="primerApellido" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Segundo Apellido *</label>
                                    <input type="text" class="form-control" name="segundoApellido" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Fecha de Nacimiento *</label>
                                    <input type="date" class="form-control" name="fechaNacimiento" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Documento de Identidad *</label>
                                    <input type="number" class="form-control" name="docIdentidad" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Datos de Contacto</label>
                                    <input type="text" class="form-control" name="datoContacto" placeholder="Teléfono, email, etc.">
                                </div>

                                <!-- Formación Profesional -->
                                <h6 class="mt-4">Formación Profesional</h6>
                                <div id="formacionesContainer">
                                    <div class="formacion-item border p-3 mb-3">
                                        <div class="mb-3">
                                            <label class="form-label">Título *</label>
                                            <input type="text" class="form-control" name="nombreTitulo[]" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Año de Obtención *</label>
                                            <input type="date" class="form-control" name="ano[]" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Descripción de Especialidad *</label>
                                            <textarea class="form-control" name="descripcionEspecialidad[]" required></textarea>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-secondary mb-3" onclick="agregarFormacion()">
                                    Agregar Formación
                                </button>

                                <!-- Idiomas -->
                                <h6 class="mt-4">Idiomas</h6>
                                <div class="mb-3">
                                    <label class="form-label">Seleccione los idiomas que domina el empleado</label>
                                    <select multiple class="form-select" name="idiomas[]" id="idiomasSelect" style="height: 150px;">
                                        <!-- Los idiomas se cargarán dinámicamente desde la base de datos -->
                                    </select>
                                    <small class="form-text text-muted">Mantenga presionada la tecla Ctrl (Windows) o Command (Mac) para seleccionar múltiples idiomas</small>
                                </div>

                                <!-- Asignación Laboral -->
                                <h6 class="mt-4">Asignación Laboral</h6>
                                <div class="mb-3">
                                    <label class="form-label">Museo *</label>
                                    <select class="form-control" name="idMuseo" required>
                                        <!-- Se llenará dinámicamente -->
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Estructura Organizacional *</label>
                                    <select class="form-control" name="idEstructuraOrg" required>
                                        <!-- Se llenará dinámicamente basado en el museo seleccionado -->
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Rol del Empleado *</label>
                                    <select class="form-control" name="rolEmpleado" required>
                                        <option value="">Seleccione un rol</option>
                                        <option value="curador">Curador</option>
                                        <option value="restaurador">Restaurador</option>
                                        <option value="administrativo">Administrativo</option>
                                        <option value="director">Director</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Fecha de Inicio *</label>
                                    <input type="date" class="form-control" name="fechaInicio" required>
                                </div>

                                <button type="submit" class="btn btn-primary">Guardar Expediente</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Lista de Empleados</h5>
                            <div id="empleadosLista" class="list-group">
                                <!-- Los empleados se cargarán aquí dinámicamente -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sección Obras -->
        <div id="obras" class="form-section">
            <h2 class="section-header">Gestión de Obras</h2>
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Nueva Obra</h5>
                            <form id="obraForm">
                                <div class="mb-3">
                                    <label class="form-label">Nombre de la Obra</label>
                                    <input type="text" class="form-control" name="nombreObra" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Fecha/Período</label>
                                    <input type="date" class="form-control" name="fechaPeriodo" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Tipo de Obra</label>
                                    <select class="form-control" name="tipoObra" required>
                                        <option value="pintura">Pintura</option>
                                        <option value="escultura">Escultura</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Dimensiones</label>
                                    <input type="text" class="form-control" name="dimensiones" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Estilo</label>
                                    <input type="text" class="form-control" name="estiloDescripcion" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Materiales y Técnicas</label>
                                    <textarea class="form-control" name="descripcionMaterialesTecnicas" rows="3" required></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">Guardar</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Lista de Obras</h5>
                            <div id="obrasLista" class="list-group">
                                <!-- Las obras se cargarán aquí dinámicamente -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sección Estructura Organizacional -->
        <div id="estructura" class="form-section">
            <h2 class="section-header">Gestión de Estructura Organizacional</h2>
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Nueva Estructura Organizacional</h5>
                            <form id="estructuraForm">
                                <div class="mb-3">
                                    <label class="form-label">Museo *</label>
                                    <select class="form-control" name="idMuseo" id="museoEstructura" required>
                                        <!-- Se llenará dinámicamente -->
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Nombre *</label>
                                    <input type="text" class="form-control" name="nombre" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Nivel *</label>
                                    <select class="form-control" name="nivel" id="nivelEstructura" onchange="actualizarTiposDisponibles()" required>
                                        <option value="">Seleccione un nivel</option>
                                        <option value="Nivel 1">Nivel 1</option>
                                        <option value="Nivel 2">Nivel 2</option>
                                        <option value="Nivel 3">Nivel 3</option>
                                        <option value="Nivel 4">Nivel 4</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Tipo *</label>
                                    <select class="form-control" name="tipo" id="tipoEstructura" required>
                                        <option value="">Seleccione primero un nivel</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Estructura Superior</label>
                                    <select class="form-control" name="idJerarquiaEstructura" id="jerarquiaEstructura">
                                        <option value="">Ninguna</option>
                                        <!-- Se llenará dinámicamente -->
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary">Guardar</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Lista de Estructuras</h5>
                            <div id="listaEstructuras" class="list-group">
                                <!-- Las estructuras se cargarán aquí dinámicamente -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function showSection(sectionId) {
            document.querySelectorAll('.form-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
        }

        async function cargarPaises() {
            try {
                const response = await fetch('/lugares/paises');
                const paises = await response.json();
                
                const paisMuseoSelect = document.getElementById('paisMuseo');
                const paisSelect = document.getElementById('paisSelect');
                
                const paisesOptions = paises.map(pais => 
                    `<option value="${pais.idLugar}">${pais.nombreLugar}</option>`
                ).join('');
                
                if (paisMuseoSelect) paisMuseoSelect.innerHTML = '<option value="">Seleccione un país</option>' + paisesOptions;
                if (paisSelect) paisSelect.innerHTML = paisesOptions;
            } catch (error) {
                console.error('Error al cargar países:', error);
            }
        }

        async function cargarCiudades() {
            const paisId = document.getElementById('paisMuseo').value;
            const ciudadSelect = document.getElementById('ciudadMuseo');
            
            if (!paisId) {
                ciudadSelect.innerHTML = '<option value="">Seleccione primero un país</option>';
                return;
            }

            try {
                const response = await fetch(`/lugares/ciudades/pais/${paisId}`);
                const ciudades = await response.json();
                
                ciudadSelect.innerHTML = ciudades.map(ciudad => 
                    `<option value="${ciudad.idLugar}">${ciudad.nombreLugar}</option>`
                ).join('');
            } catch (error) {
                console.error('Error al cargar ciudades:', error);
            }
        }

        function handleTipoLugarChange() {
            const tipoLugar = document.getElementById('tipoLugar').value;
            const paisSelectContainer = document.getElementById('paisSelectContainer');
            const paisSelect = document.getElementById('paisSelect');
            
            if (tipoLugar === 'ciudad') {
                paisSelectContainer.style.display = 'block';
                if (!paisSelect.value) {
                    paisSelect.selectedIndex = 0;
                }
            } else {
                paisSelectContainer.style.display = 'none';
                paisSelect.value = '';
            }
        }

        document.getElementById('lugarForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            
            // Convertir idJerarquia a número si existe
            if (data.idJerarquia) {
                data.idJerarquia = parseInt(data.idJerarquia);
            }

            // Si es un país, asegurarse de que idJerarquia sea null
            if (data.tipo === 'pais') {
                data.idJerarquia = null;
            }
            
            try {
                const response = await fetch('/lugares', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                });
                
                const responseData = await response.json();
                
                if (response.ok) {
                    alert('Lugar guardado exitosamente');
                    this.reset();
                    document.getElementById('tipoLugar').value = 'pais';
                    document.getElementById('paisSelectContainer').style.display = 'none';
                    document.getElementById('paisSelect').value = '';
                    cargarPaises();
                    cargarListaLugares();
                } else {
                    const errorMessage = responseData.message || 'Error al guardar el lugar';
                    console.error('Error detallado:', responseData);
                    alert(errorMessage);
                }
            } catch (error) {
                console.error('Error de conexión:', error);
                alert('Error de conexión al guardar el lugar');
            }
        });

        // Función para cargar la lista de lugares
        async function cargarListaLugares() {
            try {
                const response = await fetch('/lugares');
                const lugares = await response.json();
                
                const lugaresLista = document.getElementById('lugaresLista');
                lugaresLista.innerHTML = lugares.map(lugar => `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">${lugar.nombreLugar}</h6>
                                <small class="text-muted">Tipo: ${lugar.tipo}</small>
                                ${lugar.jerarquia ? `<br><small class="text-muted">País: ${lugar.jerarquia.nombreLugar}</small>` : ''}
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-danger" onclick="eliminarLugar(${lugar.idLugar})">
                                    Eliminar
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error al cargar lugares:', error);
            }
        }

        // Función para eliminar un lugar
        async function eliminarLugar(id) {
            if (!confirm('¿Está seguro de que desea eliminar este lugar?')) {
                return;
            }

            try {
                const response = await fetch(`/lugares/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('Lugar eliminado exitosamente');
                    cargarPaises();
                    cargarListaLugares();
                } else {
                    const errorData = await response.json();
                    alert(errorData.message || 'Error al eliminar el lugar');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al eliminar el lugar');
            }
        }

        // Cargar la lista de lugares al iniciar
        document.addEventListener('DOMContentLoaded', function() {
            cargarPaises();
            cargarListaLugares();
        });

        document.getElementById('museoForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            
            // Asegurarse de que la fecha esté en el formato correcto
            if (data.fechaFundacion) {
                const fecha = new Date(data.fechaFundacion);
                // Ajustar por la zona horaria
                fecha.setMinutes(fecha.getMinutes() + fecha.getTimezoneOffset());
                data.fechaFundacion = fecha.toISOString().split('T')[0];
            }
            
            try {
                const response = await fetch('/museos', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                });
                
                if (response.ok) {
                    alert('Museo guardado exitosamente');
                    this.reset();
                    await cargarListaMuseos();
                } else {
                    const errorData = await response.json();
                    alert(errorData.message || 'Error al guardar el museo');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al guardar el museo');
            }
        });

        // Función para agregar más campos de formación
        function agregarFormacion() {
            const container = document.getElementById('formacionesContainer');
            const formacionDiv = document.createElement('div');
            formacionDiv.className = 'formacion-item border p-3 mb-3';
            formacionDiv.innerHTML = `
                <div class="mb-3">
                    <label class="form-label">Título *</label>
                    <input type="text" class="form-control" name="nombreTitulo[]" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Año de Obtención *</label>
                    <input type="date" class="form-control" name="ano[]" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Descripción de Especialidad *</label>
                    <textarea class="form-control" name="descripcionEspecialidad[]" required></textarea>
                </div>
                <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">
                    Eliminar Formación
                </button>
            `;
            container.appendChild(formacionDiv);
        }

        // Cargar museos para la selección
        async function cargarMuseosParaEmpleado() {
            try {
                const response = await fetch('/museos');
                const museos = await response.json();
                const select = document.querySelector('select[name="idMuseo"]');
                select.innerHTML = '<option value="">Seleccione un museo</option>' + 
                    museos.map(museo => 
                        `<option value="${museo.idMuseo}">${museo.nombre}</option>`
                    ).join('');
            } catch (error) {
                console.error('Error al cargar museos:', error);
            }
        }

        // Cargar estructuras organizacionales basadas en el museo seleccionado
        async function cargarEstructurasOrg(idMuseo) {
            try {
                const response = await fetch(`/estructura-organizacional/museo/${idMuseo}`);
                const estructuras = await response.json();
                const select = document.querySelector('select[name="idEstructuraOrg"]');
                select.innerHTML = '<option value="">Seleccione una estructura</option>' + 
                    estructuras.map(estructura => 
                        `<option value="${estructura.idEstructuraOrg}">${estructura.nombre} - ${estructura.tipo}</option>`
                    ).join('');
            } catch (error) {
                console.error('Error al cargar estructuras:', error);
            }
        }

        // Event listener para cuando se selecciona un museo
        document.querySelector('select[name="idMuseo"]').addEventListener('change', function() {
            if (this.value) {
                cargarEstructurasOrg(this.value);
            }
        });

        // Modificar el event listener del formulario
        document.getElementById('empleadoForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            // Crear objeto con todos los datos
            const empleadoData = {
                empleado: {
                    primerNombre: formData.get('primerNombre'),
                    segundoNombre: formData.get('segundoNombre') || null,
                    primerApellido: formData.get('primerApellido'),
                    segundoApellido: formData.get('segundoApellido'),
                    fechaNacimiento: formData.get('fechaNacimiento'),
                    docIdentidad: Number(formData.get('docIdentidad')),
                    datoContacto: formData.get('datoContacto') || null
                },
                formaciones: Array.from(document.querySelectorAll('.formacion-item')).map(item => ({
                    nombreTitulo: item.querySelector('[name="nombreTitulo[]"]').value,
                    ano: item.querySelector('[name="ano[]"]').value,
                    descripcionEspecialidad: item.querySelector('[name="descripcionEspecialidad[]"]').value
                })),
                idiomas: Array.from(document.getElementById('idiomasSelect').selectedOptions).map(option => 
                    Number(option.value)
                ),
                asignacion: {
                    idMuseo: Number(formData.get('idMuseo')),
                    idEstructuraOrg: Number(formData.get('idEstructuraOrg')),
                    rolEmpleado: formData.get('rolEmpleado'),
                    fechaInicio: formData.get('fechaInicio')
                }
            };

            try {
                const response = await fetch('/empleados/expediente', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(empleadoData),
                });
                
                if (response.ok) {
                    alert('Expediente guardado exitosamente');
                    this.reset();
                    await cargarListaEmpleados();
                } else {
                    const errorData = await response.json();
                    alert(errorData.message || 'Error al guardar el expediente');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al guardar el expediente');
            }
        });

        // Función para cargar la lista de museos
        async function cargarListaMuseos() {
            try {
                console.log('Iniciando carga de museos...');
                const response = await fetch('/museos');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const museos = await response.json();
                console.log('Museos recibidos:', museos);
                
                const museosLista = document.getElementById('museosLista');
                if (!museosLista) {
                    console.error('No se encontró el elemento museosLista');
                    return;
                }

                museosLista.innerHTML = museos.map(museo => {
                    // Formatear la fecha correctamente
                    const fecha = new Date(museo.fechaFundacion);
                    const fechaFormateada = fecha.toLocaleDateString('es-ES', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    });

                    return `
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">${museo.nombre || 'Sin nombre'}</h6>
                                    <small class="text-muted">Fundación: ${fechaFormateada}</small>
                                    ${museo.lugar ? `<br><small class="text-muted">Ubicación: ${museo.lugar.nombreLugar}</small>` : ''}
                                </div>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-danger" onclick="eliminarMuseo(${museo.idMuseo})">
                                        Eliminar
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                console.log('Lista de museos actualizada');
            } catch (error) {
                console.error('Error al cargar museos:', error);
                museosLista.innerHTML = '<div class="alert alert-danger">Error al cargar los museos</div>';
            }
        }

        // Función para eliminar un museo
        async function eliminarMuseo(id) {
            if (!confirm('¿Está seguro de que desea eliminar este museo?')) {
                return;
            }

            try {
                const response = await fetch(`/museos/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('Museo eliminado exitosamente');
                    await cargarListaMuseos();
                    await cargarMuseosParaEmpleado(); // Actualizar también el select de museos en el formulario de empleados
                } else {
                    const errorData = await response.json();
                    alert(errorData.message || 'Error al eliminar el museo');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al eliminar el museo');
            }
        }

        // Función para cargar la lista de empleados
        async function cargarListaEmpleados() {
            try {
                const response = await fetch('/empleados');
                const empleados = await response.json();
                
                const empleadosLista = document.getElementById('empleadosLista');
                empleadosLista.innerHTML = empleados.map(empleado => `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">${empleado.primerNombre} ${empleado.primerApellido} ${empleado.segundoApellido}</h6>
                                <small class="text-muted">Doc: ${empleado.docIdentidad}</small>
                                ${empleado.datoContacto ? `<br><small class="text-muted">Contacto: ${empleado.datoContacto}</small>` : ''}
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-danger" onclick="eliminarEmpleado(${empleado.idEmpleadoProf})">
                                    Eliminar
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error al cargar empleados:', error);
            }
        }

        // Función para eliminar un empleado
        async function eliminarEmpleado(id) {
            if (!confirm('¿Está seguro de que desea eliminar este empleado?')) {
                return;
            }

            try {
                const response = await fetch(`/empleados/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('Empleado eliminado exitosamente');
                    cargarListaEmpleados();
                } else {
                    const errorData = await response.json();
                    alert(errorData.message || 'Error al eliminar el empleado');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al eliminar el empleado');
            }
        }

        // Función para cargar la lista de obras
        async function cargarListaObras() {
            try {
                const response = await fetch('/obras');
                const obras = await response.json();
                
                const obrasLista = document.getElementById('obrasLista');
                obrasLista.innerHTML = obras.map(obra => `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">${obra.nombreObra}</h6>
                                <small class="text-muted">Tipo: ${obra.tipoObra}</small>
                                <br><small class="text-muted">Período: ${obra.fechaPeriodo}</small>
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-danger" onclick="eliminarObra(${obra.idObra})">
                                    Eliminar
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error al cargar obras:', error);
            }
        }

        // Función para eliminar una obra
        async function eliminarObra(id) {
            if (!confirm('¿Está seguro de que desea eliminar esta obra?')) {
                return;
            }

            try {
                const response = await fetch(`/obras/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('Obra eliminada exitosamente');
                    cargarListaObras();
                } else {
                    const errorData = await response.json();
                    alert(errorData.message || 'Error al eliminar la obra');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al eliminar la obra');
            }
        }

        // Cargar idiomas disponibles desde la base de datos
        async function cargarIdiomas() {
            try {
                console.log('Intentando cargar idiomas...');
                const response = await fetch('/idiomas');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const idiomas = await response.json();
                console.log('Idiomas recibidos:', idiomas);
                
                const select = document.getElementById('idiomasSelect');
                if (!select) {
                    console.error('No se encontró el elemento select de idiomas');
                    return;
                }
                
                select.innerHTML = idiomas.map(idioma => 
                    `<option value="${idioma.idIdioma}">${idioma.nombre}</option>`
                ).join('');
                
                console.log('Lista de idiomas actualizada en el select');
            } catch (error) {
                console.error('Error al cargar idiomas:', error);
            }
        }

        // Función para cargar museos en el formulario de estructura
        async function cargarMuseosParaEstructura() {
            try {
                const response = await fetch('/museos');
                const museos = await response.json();
                const select = document.getElementById('museoEstructura');
                select.innerHTML = '<option value="">Seleccione un museo</option>' + 
                    museos.map(museo => 
                        `<option value="${museo.idMuseo}">${museo.nombre}</option>`
                    ).join('');
            } catch (error) {
                console.error('Error al cargar museos:', error);
            }
        }

        // Función para actualizar los tipos disponibles según el nivel seleccionado
        function actualizarTiposDisponibles() {
            const nivel = document.getElementById('nivelEstructura').value;
            const tipoSelect = document.getElementById('tipoEstructura');
            const jerarquiaContainer = document.getElementById('jerarquiaEstructura').parentElement;
            
            const tiposPorNivel = {
                'Nivel 1': [{ value: 'direccion', label: 'Dirección' }],
                'Nivel 2': [{ value: 'departamento', label: 'Departamento' }],
                'Nivel 3': [
                    { value: 'seccion', label: 'Sección' },
                    { value: 'subdepartamento', label: 'Subdepartamento' }
                ],
                'Nivel 4': [{ value: 'subseccion', label: 'Subsección' }]
            };

            // Limpiar y actualizar el select de tipos
            tipoSelect.innerHTML = '<option value="">Seleccione un tipo</option>';
            if (nivel && tiposPorNivel[nivel]) {
                tiposPorNivel[nivel].forEach(tipo => {
                    tipoSelect.innerHTML += `<option value="${tipo.value}">${tipo.label}</option>`;
                });
            }

            // Mostrar/ocultar y actualizar el campo de jerarquía según el nivel
            if (nivel === 'Nivel 1') {
                jerarquiaContainer.style.display = 'none';
            } else {
                jerarquiaContainer.style.display = 'block';
                cargarEstructurasSuperiores(nivel);
            }
        }

        // Función para cargar las estructuras superiores válidas según el nivel
        async function cargarEstructurasSuperiores(nivel) {
            try {
                const museoId = document.getElementById('museoEstructura').value;
                if (!museoId) return;

                const response = await fetch(`/estructura-organizacional/museo/${museoId}`);
                const estructuras = await response.json();
                
                const nivelNumerico = {
                    'Nivel 2': 1,
                    'Nivel 3': 2,
                    'Nivel 4': 3
                };

                const tiposValidosPorNivel = {
                    'Nivel 2': ['direccion'],
                    'Nivel 3': ['departamento'],
                    'Nivel 4': ['seccion', 'subdepartamento']
                };

                const estructurasValidas = estructuras.filter(estructura => {
                    const nivelEstructura = {
                        'Nivel 1': 1,
                        'Nivel 2': 2,
                        'Nivel 3': 3,
                        'Nivel 4': 4
                    }[estructura.nivel];

                    return nivelEstructura === nivelNumerico[nivel] &&
                           tiposValidosPorNivel[nivel].includes(estructura.tipo);
                });

                const select = document.getElementById('jerarquiaEstructura');
                select.innerHTML = '<option value="">Seleccione una estructura superior</option>' + 
                    estructurasValidas.map(estructura => 
                        `<option value="${estructura.idEstructuraOrg}">${estructura.nombre} (${estructura.tipo})</option>`
                    ).join('');
            } catch (error) {
                console.error('Error al cargar estructuras superiores:', error);
            }
        }

        // Modificar el event listener del museoEstructura
        document.getElementById('museoEstructura').addEventListener('change', function() {
            const nivel = document.getElementById('nivelEstructura').value;
            if (nivel && nivel !== 'Nivel 1') {
                cargarEstructurasSuperiores(nivel);
            }
            cargarListaEstructuras();
        });

        // Actualizar la función cargarListaEstructuras
        async function cargarListaEstructuras() {
            try {
                const museoId = document.getElementById('museoEstructura').value;
                if (!museoId) {
                    document.getElementById('listaEstructuras').innerHTML = '<p>Seleccione un museo para ver sus estructuras</p>';
                    return;
                }

                const response = await fetch(`/estructura-organizacional/museo/${museoId}`);
                const estructuras = await response.json();

                if (estructuras.length === 0) {
                    document.getElementById('listaEstructuras').innerHTML = '<p>No hay estructuras organizacionales registradas para este museo</p>';
                    return;
                }

                let html = '<ul class="list-group">';
                estructuras.forEach(estructura => {
                    html += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${estructura.nombreEstructura}</strong><br>
                                <small>Nivel: ${estructura.nivel} - Tipo: ${estructura.tipo}</small>
                            </div>
                            <button class="btn btn-danger btn-sm" onclick="eliminarEstructura(${estructura.idMuseo}, ${estructura.idEstructuraOrg})">
                                Eliminar
                            </button>
                        </li>`;
                });
                html += '</ul>';
                document.getElementById('listaEstructuras').innerHTML = html;
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('listaEstructuras').innerHTML = '<p class="text-danger">Error al cargar las estructuras organizacionales</p>';
            }
        }

        // Actualizar la función eliminarEstructura para usar los nuevos endpoints
        async function eliminarEstructura(idMuseo, idEstructuraOrg) {
            if (!confirm('¿Está seguro de que desea eliminar esta estructura organizacional?')) {
                return;
            }

            try {
                const response = await fetch(`/estructura-organizacional/${idMuseo}/${idEstructuraOrg}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('Estructura organizacional eliminada exitosamente');
                    await cargarListaEstructuras();
                } else {
                    const errorData = await response.json();
                    alert(errorData.message || 'Error al eliminar la estructura organizacional');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al eliminar la estructura organizacional');
            }
        }

        // Agregar la carga de museos para estructura al DOMContentLoaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM cargado, iniciando carga de datos...');
            // Cargar datos para el formulario de empleados
            cargarIdiomas();
            cargarMuseosParaEmpleado();
            cargarListaEmpleados();
            
            // Cargar datos para otras secciones
            cargarPaises();
            cargarListaLugares();
            cargarListaMuseos();
            cargarListaObras();
            cargarMuseosParaEstructura();
        });
    </script>
</body>
</html> 